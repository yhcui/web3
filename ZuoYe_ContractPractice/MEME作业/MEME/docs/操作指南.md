# ShibaMemeCoin 操作指南

## 概述

本指南详细说明如何部署和使用 SHIB 风格的 MEME 代币合约。该合约实现了代币税机制、流动性池集成和交易限制功能。

## 目录

1. [环境准备](#环境准备)
2. [合约部署](#合约部署)
3. [基本操作](#基本操作)
4. [高级功能](#高级功能)
5. [流动性管理](#流动性管理)
6. [安全功能](#安全功能)
7. [监控和维护](#监控和维护)
8. [故障排除](#故障排除)

## 环境准备

### 1. 依赖安装

```bash
# 安装 Node.js 依赖
npm install --save-dev hardhat
npm install --save-dev @openzeppelin/contracts
npm install --save-dev @nomiclabs/hardhat-ethers
npm install --save-dev ethers

# 安装 Uniswap 依赖（用于本地测试）
npm install --save-dev @uniswap/v2-core
npm install --save-dev @uniswap/v2-periphery
```

### 2. 配置文件

创建 `hardhat.config.js`:

```javascript
require("@nomiclabs/hardhat-ethers");

module.exports = {
  solidity: {
    version: "0.8.19",
    settings: {
      optimizer: {
        enabled: true,
        runs: 200
      }
    }
  },
  networks: {
    localhost: {
      url: "http://127.0.0.1:8545"
    },
    goerli: {
      url: "YOUR_GOERLI_RPC_URL",
      accounts: ["YOUR_PRIVATE_KEY"]
    },
    mainnet: {
      url: "YOUR_MAINNET_RPC_URL",
      accounts: ["YOUR_PRIVATE_KEY"]
    }
  }
};
```

### 3. 环境变量

创建 `.env` 文件:

```bash
PRIVATE_KEY=your_private_key_here
MARKETING_WALLET=0x742d35Cc6634C0532925a3b8D76Cc05d6Bc7Ab...
LIQUIDITY_WALLET=0xdD2FD4581271e230360230F9337D5c0430Bf44C0...
ETHERSCAN_API_KEY=your_etherscan_api_key
```

## 合约部署

### 1. 本地部署

```bash
# 启动本地网络
npx hardhat node

# 在另一个终端中部署合约
npx hardhat run scripts/deploy.js --network localhost
```

### 2. 测试网部署

```bash
# 部署到 Goerli 测试网
npx hardhat run scripts/deploy.js --network goerli

# 验证合约
npx hardhat verify --network goerli CONTRACT_ADDRESS "MARKETING_WALLET" "LIQUIDITY_WALLET" "ROUTER_ADDRESS"
```

### 3. 主网部署

```bash
# 部署到主网（谨慎操作）
npx hardhat run scripts/deploy.js --network mainnet

# 验证合约
npx hardhat verify --network mainnet CONTRACT_ADDRESS "MARKETING_WALLET" "LIQUIDITY_WALLET" "ROUTER_ADDRESS"
```

## 基本操作

### 1. 启用交易

合约部署后，交易默认被禁用。需要手动启用：

```javascript
// 连接到合约
const contract = await ethers.getContractAt("ShibaMemeCoin", CONTRACT_ADDRESS);

// 启用交易
await contract.enableTrading(true);
```

### 2. 代币转账

```javascript
// 普通转账（会收取转账税）
const amount = ethers.utils.parseEther("1000"); // 1000 代币
await contract.transfer(recipientAddress, amount);

// 免费转账（需要先设置费用豁免）
await contract.excludeFromFees(recipientAddress, true);
await contract.transfer(recipientAddress, amount);
```

### 3. 查看余额

```javascript
const balance = await contract.balanceOf(userAddress);
console.log("余额:", ethers.utils.formatEther(balance));
```

### 4. 查看合约信息

```javascript
const tokenInfo = await contract.getTokenInfo();
console.log("总供应量:", ethers.utils.formatEther(tokenInfo.totalSupply_));
console.log("流通供应量:", ethers.utils.formatEther(tokenInfo.circulatingSupply));
console.log("已销毁代币:", ethers.utils.formatEther(tokenInfo.burnedTokens));
```

## 高级功能

### 1. 税费配置管理

```javascript
// 查看当前税费配置
const feeInfo = await contract.getFeeInfo();
console.log("买入税:", feeInfo.buyTax / 100, "%");
console.log("卖出税:", feeInfo.sellTax / 100, "%");

// 更新税费配置（只有所有者可以执行）
const newTaxRates = {
    buyTax: 300,        // 3%
    sellTax: 500,       // 5%
    transferTax: 100,   // 1%
    liquidityFee: 200,  // 2%
    reflectionFee: 200, // 2%
    burnFee: 100,       // 1%
    marketingFee: 300   // 3%
};

await contract.updateTaxRates(newTaxRates);
```

### 2. 交易限制管理

```javascript
// 查看当前限制配置
const limitInfo = await contract.getLimitInfo();
console.log("最大交易量:", ethers.utils.formatEther(limitInfo.maxTransactionAmount));
console.log("最大持有量:", ethers.utils.formatEther(limitInfo.maxWalletAmount));

// 更新交易限制
const newLimits = {
    maxTransactionAmount: ethers.utils.parseEther("100000"), // 10万代币
    maxWalletAmount: ethers.utils.parseEther("200000"),      // 20万代币
    minTimeBetweenTx: 30, // 30秒间隔
    limitsInEffect: true
};

await contract.updateTradingLimits(newLimits);
```

### 3. 豁免管理

```javascript
// 设置费用豁免
await contract.excludeFromFees(userAddress, true);  // 豁免费用
await contract.excludeFromFees(userAddress, false); // 取消豁免

// 设置限制豁免
await contract.excludeFromLimits(userAddress, true);  // 豁免限制
await contract.excludeFromLimits(userAddress, false); // 取消豁免

// 查看豁免状态
const isExcludedFromFees = await contract.isExcludedFromFees(userAddress);
const isExcludedFromLimits = await contract.isExcludedFromLimits(userAddress);
```

## 流动性管理

### 1. 添加初始流动性

```javascript
// 首先需要向 Uniswap 路由合约授权
const router = await ethers.getContractAt("IUniswapV2Router02", ROUTER_ADDRESS);
const tokenAmount = ethers.utils.parseEther("500000000"); // 5亿代币
const ethAmount = ethers.utils.parseEther("10"); // 10 ETH

// 授权路由合约
await contract.approve(router.address, tokenAmount);

// 添加流动性
await router.addLiquidityETH(
    contract.address,
    tokenAmount,
    0, // 最小代币量（设为0表示接受任何数量）
    0, // 最小ETH量（设为0表示接受任何数量）
    owner.address, // LP代币接收地址
    Math.floor(Date.now() / 1000) + 3600, // 截止时间（1小时后）
    { value: ethAmount }
);
```

### 2. 自动流动性添加

合约会自动将税费的一部分添加到流动性池中：

```javascript
// 手动触发流动性添加（当合约代币余额达到阈值时）
await contract.manualSwapAndLiquify();
```

### 3. 流动性池配置

```javascript
// 查看当前流动性池地址
const pairAddress = await contract.uniswapV2Pair();
console.log("流动性池地址:", pairAddress);

// 设置新的自动化做市商对
await contract.setAutomatedMarketMakerPair(newPairAddress, true);
```

## 安全功能

### 1. 黑名单管理

```javascript
// 添加地址到黑名单
await contract.blacklist(maliciousAddress, true);

// 从黑名单移除地址
await contract.blacklist(maliciousAddress, false);

// 查看黑名单状态
const isBlacklisted = await contract.isBlacklisted(userAddress);
```

### 2. 紧急功能

```javascript
// 禁用交易（紧急情况）
await contract.enableTrading(false);

// 紧急提取ETH
await contract.emergencyWithdrawETH();

// 紧急提取其他代币
await contract.emergencyWithdrawTokens(tokenAddress);
```

### 3. 钱包地址更新

```javascript
// 更新营销钱包
await contract.updateMarketingWallet(newMarketingWallet);

// 更新流动性钱包
await contract.updateLiquidityWallet(newLiquidityWallet);
```

## 监控和维护

### 1. 事件监听

```javascript
// 监听交易启用事件
contract.on("TradingEnabled", (enabled) => {
    console.log("交易状态变更:", enabled);
});

// 监听税费更新事件
contract.on("TaxRatesUpdated", (newRates) => {
    console.log("税费已更新:", newRates);
});

// 监听流动性添加事件
contract.on("SwapAndLiquify", (tokensSwapped, ethReceived, tokensIntoLiquidity) => {
    console.log("流动性添加:", {
        tokensSwapped: ethers.utils.formatEther(tokensSwapped),
        ethReceived: ethers.utils.formatEther(ethReceived),
        tokensIntoLiquidity: ethers.utils.formatEther(tokensIntoLiquidity)
    });
});
```

### 2. 定期检查

```javascript
// 定期检查合约状态
async function checkContractHealth() {
    const tokenInfo = await contract.getTokenInfo();
    const contractBalance = tokenInfo.contractBalance;
    const swapThreshold = await contract.swapThreshold();

    if (contractBalance.gte(swapThreshold)) {
        console.log("合约代币余额达到交换阈值，可能需要手动触发交换");
    }

    // 检查是否有足够的ETH进行交换
    const ethBalance = await ethers.provider.getBalance(contract.address);
    console.log("合约ETH余额:", ethers.utils.formatEther(ethBalance));
}

// 每小时检查一次
setInterval(checkContractHealth, 3600000);
```

### 3. 性能监控

```javascript
// 监控燃料消耗
async function monitorGasUsage() {
    const gasPrice = await ethers.provider.getGasPrice();
    console.log("当前燃料价格:", ethers.utils.formatUnits(gasPrice, "gwei"), "gwei");

    // 估算各种操作的燃料成本
    const transferGas = await contract.estimateGas.transfer(userAddress, ethers.utils.parseEther("1000"));
    const swapGas = await contract.estimateGas.manualSwapAndLiquify();

    console.log("转账燃料消耗:", transferGas.toString());
    console.log("交换燃料消耗:", swapGas.toString());
}
```

## 故障排除

### 1. 常见错误及解决方案

#### 交易被拒绝
```
错误: "Trading not enabled"
解决: 确保已调用 enableTrading(true)
```

```
错误: "Exceeds max transaction amount"
解决: 减少交易数量或更新交易限制
```

```
错误: "Blacklisted address"
解决: 检查发送方或接收方是否在黑名单中
```

#### 流动性相关问题
```
错误: "UniswapV2: INSUFFICIENT_LIQUIDITY"
解决: 确保流动性池有足够的代币和ETH
```

```
错误: "UniswapV2: TRANSFER_FROM_FAILED"
解决: 确保合约有足够的代币授权给路由合约
```

### 2. 调试工具

```javascript
// 查看详细的合约状态
async function debugContractState() {
    console.log("=== 合约调试信息 ===");

    const tokenInfo = await contract.getTokenInfo();
    const feeInfo = await contract.getFeeInfo();
    const limitInfo = await contract.getLimitInfo();

    console.log("交易状态:", tokenInfo.tradingEnabled_);
    console.log("交换状态:", tokenInfo.swapEnabled_);
    console.log("合约余额:", ethers.utils.formatEther(tokenInfo.contractBalance));

    console.log("当前税费:", feeInfo);
    console.log("当前限制:", limitInfo);

    const pairAddress = await contract.uniswapV2Pair();
    const pairBalance = await contract.balanceOf(pairAddress);
    console.log("流动性池代币余额:", ethers.utils.formatEther(pairBalance));
}
```

### 3. 网络特定注意事项

#### 主网部署
- 确保有足够的ETH支付燃料费
- 使用较高的燃料价格确保交易快速确认
- 仔细检查所有参数，主网部署后无法轻易修改

#### 测试网部署
- 可以使用测试网水龙头获取测试ETH
- 可以多次部署进行测试
- 测试网可能存在不稳定性，交易可能失败

#### 本地网络
- 需要部署模拟的Uniswap合约
- 可以快速迭代和测试
- 不涉及真实资金，安全性高

## 最佳实践

### 1. 部署前检查清单
- [ ] 验证所有地址参数正确
- [ ] 检查税费配置合理
- [ ] 确认交易限制适当
- [ ] 测试所有核心功能
- [ ] 进行安全审计

### 2. 运营建议
- 逐步降低交易限制
- 定期监控合约状态
- 保持社区沟通透明
- 准备紧急应对方案
- 定期备份重要数据

### 3. 安全建议
- 使用多签钱包作为所有者
- 限制关键功能的访问权限
- 定期更新依赖库
- 监控异常交易活动
- 准备暂停机制

## 总结

ShibaMemeCoin 合约提供了完整的 MEME 代币功能，包括代币税、流动性管理和交易限制。正确使用本指南可以确保安全、高效地部署和运营您的 MEME 代币项目。

如需技术支持或有任何疑问，请参考合约源码中的详细注释或联系开发团队。
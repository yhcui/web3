# MetaNodeStake 质押时间段节点说明

## 时间节点概览

基于 `MetaNodeStake.sol` 合约的时间逻辑，质押系统包含以下关键时间节点：

### 1. 部署时间 (Deployment Time)
- **定义**: 合约通过 `initialize()` 函数初始化部署的时间点
- **代码位置**: `197:219:stake-contract/contracts/MetaNodeStake.sol`
- **关键参数**: 
  - `_startBlock`: 质押开始区块高度
  - `_endBlock`: 质押结束区块高度
  - `_MetaNodePerBlock`: 每个区块的 MetaNode 奖励数量

### 2. 开始生息时间 (Start Block / startBlock)
- **定义**: 质押开始区块高度，从此区块开始计算奖励
- **代码位置**: `91:91:stake-contract/contracts/MetaNodeStake.sol`
- **关键逻辑**:
  ```solidity
  // 在 getMultiplier 函数中，如果 _from < startBlock，则从 startBlock 开始计算
  if (_from < startBlock) {
      _from = startBlock;
  }
  ```
- **功能**: 
  - 从 `startBlock` 开始，用户可以开始质押
  - 奖励计算从 `startBlock` 开始
  - 在 `startBlock` 之前质押的，奖励仍从 `startBlock` 开始计算

### 3. Deposit Window (质押窗口期)
- **定义**: 用户可以自由进行质押的时间段
- **时间范围**: `[startBlock, endBlock)`
- **代码检查**: 
  ```solidity
  // addPool 函数中检查：只能在 endBlock 之前添加池子
  require(block.number < endBlock, "Already ended");
  
  // deposit 和 depositETH 函数可以在此时间段内任意时间调用
  ```
- **特点**:
  - 用户在 `deposit window` 内的任意时间都可以进入质押
  - 直到达到最大质押额度（如果设置了上限）
  - 每个用户的 `deposit time` 单独记录

### 4. 结束时间 (End Block / endBlock)
- **定义**: 质押结束区块高度
- **代码位置**: `93:93:stake-contract/contracts/MetaNodeStake.sol`
- **关键逻辑**:
  ```solidity
  // 在 getMultiplier 函数中，如果 _to > endBlock，则只计算到 endBlock
  if (_to > endBlock) {
      _to = endBlock;
  }
  ```
- **两种结束方式**:
  1. **设置结束时间 (设置 endBlock)**: 
     - Admin 通过 `setEndBlock()` 函数设置
     - 到达 `endBlock` 后，不能再添加新的池子
     - 但已质押的用户仍可以领取奖励
     
  2. **全局打满**:
     - 当达到最大质押额度时，实际停止接受新的质押
     - 但仍需要显式设置 `endBlock` 来限制奖励计算

## 合约中的时间相关函数

### 初始化时间
```solidity
function initialize(
    IERC20 _MetaNode,
    uint256 _startBlock,
    uint256 _endBlock,
    uint256 _MetaNodePerBlock
) public initializer
```
- 在部署时设置 `startBlock` 和 `endBlock`
- 要求: `_startBlock <= _endBlock`

### 更新开始时间
```solidity
function setStartBlock(uint256 _startBlock) public onlyRole(ADMIN_ROLE)
```
- 只能由 Admin 调用
- 要求: `_startBlock <= endBlock`

### 更新结束时间
```solidity
function setEndBlock(uint256 _endBlock) public onlyRole(ADMIN_ROLE)
```
- 只能由 Admin 调用
- 要求: `startBlock <= _endBlock`

### 计算奖励倍数
```solidity
function getMultiplier(uint256 _from, uint256 _to) public view returns (uint256 multiplier)
```
- 自动将时间范围限制在 `[startBlock, endBlock]` 内
- 如果 `_from < startBlock`，则从 `startBlock` 开始计算
- 如果 `_to > endBlock`，则只计算到 `endBlock`

## 用户操作的时间限制

### Deposit (质押)
- **允许时间**: `[startBlock, endBlock)` 
- **代码检查**: 在 `addPool` 中检查 `block.number < endBlock`
- **功能**: 用户可以在 deposit window 内任意时间质押

### Unstake (解质押)
- **时间限制**: 可以在质押后的任意时间发起解质押请求
- **锁定机制**: 发起解质押后，需要等待 `unstakeLockedBlocks` 个区块才能提取
- **代码位置**: `630:665:stake-contract/contracts/MetaNodeStake.sol`
  ```solidity
  user_.requests.push(
      UnstakeRequest({
          amount: _amount,
          unlockBlocks: block.number + pool_.unstakeLockedBlocks
      })
  );
  ```

### Withdraw (提取)
- **时间限制**: 只有在 `unlockBlocks <= block.number` 时才能提取
- **代码位置**: `672:708:stake-contract/contracts/MetaNodeStake.sol`

### Claim (领取奖励)
- **时间限制**: 可以在质押后的任意时间领取奖励
- **计算方式**: 奖励从用户的 `deposit time` 开始计算，但不会超过 `endBlock`
- **代码位置**: `715:738:stake-contract/contracts/MetaNodeStake.sol`

## 奖励计算逻辑

每个用户在任意时刻可领取的 MetaNode 数量：
```
pendingMetaNode = (user.stAmount * pool.accMetaNodePerST) / (1 ether) - user.finishedMetaNode + user.pendingMetaNode
```

奖励计算的时间范围被自动限制在 `[startBlock, endBlock]` 内：
- 如果用户质押时间早于 `startBlock`，奖励仍从 `startBlock` 开始计算
- 如果当前区块超过 `endBlock`，奖励只计算到 `endBlock`

## 全局状态

- **active 状态**: 可以通过 `paused` 状态来控制（继承自 `PausableUpgradeable`）
- **withdrawPaused**: 暂停提现功能
- **claimPaused**: 暂停领取功能

## 使用建议

1. **部署时设置**: 在 `initialize` 中设置合理的 `startBlock` 和 `endBlock`
2. **灵活调整**: 可以使用 `setStartBlock` 和 `setEndBlock` 调整时间范围
3. **提前规划**: 建议在部署前确定 deposit window 的时长
4. **监控状态**: 定期检查是否达到最大质押额度，必要时设置 `endBlock`


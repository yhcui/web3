# MetaNodeStake 项目架构图

## 项目概述

MetaNodeStake 是一个基于以太坊的多池质押系统，支持用户质押 ETH 或 ERC20 代币，并根据质押时间和数量获取 MetaNode 代币奖励。系统采用可升级合约设计，具有基于角色的访问控制和灵活的质押参数配置功能。

## 系统架构图

```mermaid
flowchart TD
    subgraph 用户层
        User["用户/质押者"]
        Admin["管理员"]
    end

    subgraph 合约层
        MetaNodeStake["MetaNodeStake.sol<br>质押主合约"]
        MetaNodeToken["MetaNodeToken.sol<br>奖励代币"]
        IERC20["IERC20<br>代币接口"]
    end

    subgraph 功能模块
        PoolMgmt["池管理模块"]
        StakeMgmt["质押管理模块"]
        RewardMgmt["奖励管理模块"]
        AdminCtrl["管理员控制模块"]
        AccessCtrl["访问控制模块"]
    end

    subgraph 数据结构
        Pool["Pool结构<br>存储池信息"]
        User["User结构<br>存储用户质押信息"]
        UnstakeRequest["UnstakeRequest结构<br>存储提现请求"]
    end

    User -->|1. 质押| StakeMgmt
    User -->|2. 申请解绑| StakeMgmt
    User -->|3. 领取奖励| RewardMgmt
    User -->|4. 提取资金| StakeMgmt
    
    Admin -->|5. 管理池参数| AdminCtrl
    Admin -->|6. 暂停/恢复功能| AdminCtrl
    Admin -->|7. 升级合约| AccessCtrl
    
    MetaNodeStake --> PoolMgmt
    MetaNodeStake --> StakeMgmt
    MetaNodeStake --> RewardMgmt
    MetaNodeStake --> AdminCtrl
    MetaNodeStake --> AccessCtrl
    
    PoolMgmt --> Pool
    StakeMgmt --> User
    StakeMgmt --> UnstakeRequest
    RewardMgmt --> User
    
    MetaNodeStake -->|奖励发放| MetaNodeToken
    MetaNodeStake -->|质押ERC20| IERC20

    AccessCtrl -->|继承| AccessControlUpgradeable
    AccessCtrl -->|继承| Initializable
    AccessCtrl -->|继承| UUPSUpgradeable
    AccessCtrl -->|继承| PausableUpgradeable
```

## 合约关系

```mermaid
classDiagram
    class Initializable {
        <<interface>>
    }
    
    class UUPSUpgradeable {
        <<interface>>
    }
    
    class AccessControlUpgradeable {
        <<interface>>
    }
    
    class PausableUpgradeable {
        <<interface>>
    }
    
    class MetaNodeToken {
        +构造函数()
    }
    
    class IERC20 {
        <<interface>>
    }
    
    class MetaNodeStake {
        -ADMIN_ROLE
        -UPGRADE_ROLE
        -ETH_PID
        -pool[]
        -user[uint256][address]
        +initialize()
        +deposit()
        +depositETH()
        +unstake()
        +withdraw()
        +claim()
        +addPool()
        +updatePool()
        +setPoolWeight()
    }
    
    class Pool {
        -stTokenAddress
        -poolWeight
        -lastRewardBlock
        -accMetaNodePerST
        -stTokenAmount
        -minDepositAmount
        -unstakeLockedBlocks
    }
    
    class User {
        -stAmount
        -finishedMetaNode
        -pendingMetaNode
        -requests[]
    }
    
    class UnstakeRequest {
        -amount
        -unlockBlocks
    }
    
    MetaNodeStake --|> Initializable
    MetaNodeStake --|> UUPSUpgradeable
    MetaNodeStake --|> AccessControlUpgradeable
    MetaNodeStake --|> PausableUpgradeable
    
    MetaNodeToken --|> IERC20
    
    MetaNodeStake -- MetaNodeToken : 奖励发放
    MetaNodeStake -- IERC20 : 质押操作
    
    MetaNodeStake *-- Pool : 包含多个
    MetaNodeStake *-- User : 包含多个
    User *-- UnstakeRequest : 包含多个
```

## 主要功能流程

### 1. 质押流程

```mermaid
sequenceDiagram
    participant 用户
    participant MetaNodeStake
    participant ERC20Token
    participant 奖励计算
    
    用户->>MetaNodeStake: deposit(pid, amount)
    MetaNodeStake->>MetaNodeStake: 检查池ID有效性
    MetaNodeStake->>MetaNodeStake: 检查最小质押金额
    MetaNodeStake->>ERC20Token: transferFrom(user, contract, amount)
    MetaNodeStake->>奖励计算: 计算并分配未领取奖励
    MetaNodeStake->>MetaNodeStake: 更新用户质押信息
    MetaNodeStake-->>用户: 返回质押成功
```

### 2. 奖励分配流程

```mermaid
sequenceDiagram
    participant 用户
    participant MetaNodeStake
    participant MetaNodeToken
    participant 池更新
    
    用户->>MetaNodeStake: 执行任何操作（deposit/withdraw/claim）
    MetaNodeStake->>池更新: updatePool(pid)
    池更新->>池更新: 计算区块奖励倍数
    池更新->>池更新: 计算池奖励份额
    池更新->>池更新: 更新累加奖励率
    MetaNodeStake->>MetaNodeStake: 计算用户未领取奖励
    MetaNodeStake-->>用户: 继续执行操作
```

### 3. 解绑和提取流程

```mermaid
sequenceDiagram
    participant 用户
    participant MetaNodeStake
    participant ERC20Token
    
    用户->>MetaNodeStake: unstake(pid, amount)
    MetaNodeStake->>MetaNodeStake: 验证质押余额
    MetaNodeStake->>MetaNodeStake: 计算并分配未领取奖励
    MetaNodeStake->>MetaNodeStake: 创建解绑请求，设置锁定时间
    MetaNodeStake-->>用户: 返回解绑请求创建成功
    
    Note over 用户,MetaNodeStake: 等待锁定区块数
    
    用户->>MetaNodeStake: withdraw(pid)
    MetaNodeStake->>MetaNodeStake: 验证锁定时间已过
    MetaNodeStake->>ERC20Token: transfer(user, amount)
    MetaNodeStake->>MetaNodeStake: 清理解绑请求
    MetaNodeStake-->>用户: 返回提取成功
```

## 核心模块详解

### 1. 池管理模块
- 支持多池质押，第一个池固定为ETH池
- 每个池有独立的权重、最小质押金额、锁定区块数等参数
- 管理员可以动态调整池参数和权重

### 2. 质押管理模块
- 支持ETH和ERC20代币质押
- 实现质押、解绑申请、提取功能
- 解绑有锁定机制，需等待指定区块数后才能提取

### 3. 奖励管理模块
- 基于区块产出MetaNode奖励
- 按池权重分配奖励
- 实时计算用户未领取奖励
- 支持奖励领取功能

### 4. 管理员控制模块
- 角色管理：ADMIN_ROLE和UPGRADE_ROLE
- 功能暂停/恢复：提现和领取奖励
- 参数调整：开始区块、结束区块、区块奖励等

### 5. 访问控制模块
- 基于OpenZeppelin的AccessControlUpgradeable实现角色控制
- 基于UUPSUpgradeable实现合约可升级
- 基于PausableUpgradeable实现功能暂停
